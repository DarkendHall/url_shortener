services:
  service1:
    restart: on-failure
    depends_on:
      - db
      - consul
    image: ghcr.io/darkendhall/url_shortener:latest
    ports:
      - "8080:8080"
    networks:
      - url-shortener
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/short" ]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      CONSUL_HOST: consul

  service2:
    restart: on-failure
    depends_on:
      - db
      - consul
    image: ghcr.io/darkendhall/url_shortener:latest
    ports:
      - "8081:8080"
    networks:
      - url-shortener
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/short" ]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      CONSUL_HOST: consul

  service3:
    restart: on-failure
    depends_on:
      - db
      - consul
    image: ghcr.io/darkendhall/url_shortener:latest
    ports:
      - "8082:8080"
    networks:
      - url-shortener
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/short" ]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      CONSUL_HOST: consul

  db:
    image: mysql:8.0.27
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
    networks:
      - url-shortener

  consul:
    image: consul:1.12.0
    ports:
      - "8500:8500"
      - "8600:8600"
    networks:
      - url-shortener
    environment:
      CONSUL_LOCAL_CONFIG:
        '{
          "server": true,
          "ui_config": {
            "enabled": true
          },
          "node_name": "server-1",
          "bootstrap_expect": 1
        }'

volumes:
  mysql-data: { }
  consul-data: { }

networks:
  url-shortener: { }
